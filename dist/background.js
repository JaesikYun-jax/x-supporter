class g{static async get(r){try{return(await chrome.storage.local.get(r))[r]}catch(e){console.error(`스토리지에서 데이터 가져오기 실패: ${e}`);return}}static async set(r,e){try{await chrome.storage.local.set({[r]:e})}catch(o){console.error(`스토리지에 데이터 저장 실패: ${o}`)}}static async remove(r){try{await chrome.storage.local.remove(r)}catch(e){console.error(`스토리지에서 데이터 삭제 실패: ${e}`)}}static onChanged(r){chrome.storage.onChanged.addListener((e,o)=>{o==="local"&&r(e)})}}const S={systemPrompt:`당신은 Web3와 암호화폐 열정가인 'Web3 Degen'의 역할로 X.com에서 트윗 컨텍스트를 기반한 답변을 작성해야 한다.
답변의 특징은 다음과 같다.

1. 'gm', 'ser', 'fren', 'wen', 'WAGMI', 'NGMI', 'alpha', 'degen', '3 commas'와 같은 Web3 슬랭과 용어를 사용하세요.
2. 토큰 가격, 커뮤니티적 교류가 중심인 상황에서 '🚀', '💎🙌', 'lfg', 'bullish'와 같은 표현을 사용하세요.
3. 대화를 시작할 때는 'gm' 또는 'gn'로 시작하는 것이 좋습니다.
4. 친근하고 격식 없는 말투를 유지하세요.
5. 첫 글자를 대문자로 사용하지 마세요. 모두 소문자로 쓰고 문법을 일부러 틀리거나 축약어를 적극적으로 사용하세요.`,userPrompt:`다음 트윗 스레드에 대한 Web3 스타일의 대답을 3가지 타입으로 생성해주세요:
전체적인 맥락을 고려하되 최종적으로는 최소한의 문장으로 답변하세요.
{{THREAD_CONTEXT}}

다음 형식으로 정확히 3개의 응답을 제공해주세요:

1/ [짧고 친근한 인사 - Web3 슬랭 사용]

2/ [트윗 내용 일부를 인용하며 동의하는 내용]

3/ [자기 비하적인 Web3/암호화폐 관련 농담]

각 응답은 정확히 "1/", "2/", "3/"로 시작해야 하며, 응답 간에는 빈 줄을 추가해주세요.
어떤 내용이든 반드시 이 형식을 따라주세요.`};function C(t){if(!t)return"대화 컨텍스트 없음";let r="";if(t.mainTweet){const e=t.mainTweet;r+=`메인 트윗 (@${e.author.username}): "${e.text}"

`}if(t.intermediateReplies&&t.intermediateReplies.length>0&&(r+=`중간 답글들:
`,t.intermediateReplies.forEach((e,o)=>{r+=`${o+1}. @${e.author.username}: "${e.text}"
`}),r+=`
`),t.replyTarget){const e=t.replyTarget;r+=`답장 대상 (@${e.author.username}): "${e.text}"`}return r}function P(t){const r=C(t),e=S.userPrompt.replace(/{{THREAD_CONTEXT}}/g,r);return{systemPrompt:S.systemPrompt,userPrompt:e}}const d={isAlive:!0,startTime:Date.now(),pingInterval:null,wakeInterval:null,pendingResponses:new Map,keepAlive(){this.wakeInterval&&(clearInterval(this.wakeInterval),this.wakeInterval=null),this.wakeInterval=setInterval(()=>{this.isAlive=!0;const t=Math.floor((Date.now()-this.startTime)/1e3);console.debug(`백그라운드 스크립트 활성 유지 중 (가동 시간: ${t}초)`),t>0&&t%1500===0&&s.addLog(`백그라운드 스크립트 가동 중 (${Math.floor(t/60)}분)`,"info")},15e3),this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.pingInterval=setInterval(async()=>{try{await this.pingContentScriptTabs()}catch(t){console.debug("탭 핑 오류:",t)}},3e4)},async pingContentScriptTabs(){const t=[...b.contentScriptTabs];for(const r of t)try{await b.isContentScriptActive(r)}catch(e){console.debug(`탭 ${r} 핑 실패:`,e)}},registerPendingResponse(t,r){this.pendingResponses.set(t,r),setTimeout(()=>{this.pendingResponses.delete(t)},1e4)},hasPendingResponse(t){return this.pendingResponses.has(t)},executePendingResponse(t,r){if(this.pendingResponses.has(t)){try{this.pendingResponses.get(t)(r)}catch(e){console.error("응답 콜백 실행 오류:",e)}return this.pendingResponses.delete(t),!0}return!1},cleanup(){this.wakeInterval&&(clearInterval(this.wakeInterval),this.wakeInterval=null),this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.pendingResponses.clear()}},b={active:!0,contentScriptTabs:new Set,registerContentScript(t){this.contentScriptTabs.add(t),console.log(`콘텐츠 스크립트 등록: 탭 ${t}`)},unregisterContentScript(t){this.contentScriptTabs.delete(t),console.log(`콘텐츠 스크립트 연결 해제: 탭 ${t}`)},async broadcastMessage(t){const r=[...this.contentScriptTabs];for(const e of r)try{await chrome.tabs.sendMessage(e,t)}catch(o){console.warn(`탭 ${e}에 메시지 전송 실패:`,o),this.unregisterContentScript(e)}},async isContentScriptActive(t){if(!this.contentScriptTabs.has(t))return!1;try{const r=await Promise.race([chrome.tabs.sendMessage(t,{action:"ping",timestamp:Date.now()}),new Promise((e,o)=>setTimeout(()=>o(new Error("Ping timeout")),2e3))]);return!0}catch(r){return console.warn(`탭 ${t} 연결 확인 실패:`,r),this.unregisterContentScript(t),!1}},async checkAllContentScripts(){const t=[...this.contentScriptTabs],r=[];for(const e of t)try{const o=await this.isContentScriptActive(e);r.push({tabId:e,active:o})}catch{r.push({tabId:e,active:!1})}return r}},L={isEnabled:!0,apiKey:"",model:"gpt-4o-mini",modelOptions:["gpt-4o-mini","gpt-3.5-turbo","gpt-4"],toneOptions:["Web3 Degen"],selectedTone:"Web3 Degen",useCustomPrompt:!1,customPrompt:""},s={MAX_LOGS:100,async addLog(t,r="info",e){const o=await this.getLogs(),c={timestamp:new Date().toISOString(),message:t,type:r,details:e?JSON.stringify(e):void 0};o.unshift(c),o.length>this.MAX_LOGS&&o.pop(),await g.set("debug_logs",o),console.log(`[${r.toUpperCase()}] ${t}`,e||""),this.notifyLogUpdate()},async getLogs(){const t=await g.get("debug_logs");return Array.isArray(t)?t:[]},async clearLogs(){await g.set("debug_logs",[]),this.notifyLogUpdate()},notifyLogUpdate(){try{chrome.runtime.sendMessage({action:"logUpdated"}).catch(t=>{console.debug("로그 업데이트 알림 실패 (팝업이 열려있지 않을 수 있음)")})}catch{console.debug("로그 업데이트 알림 실패 (팝업이 열려있지 않을 수 있음)")}}},I={},T={lastContext:null,contextHistory:[],MAX_HISTORY_SIZE:10,saveContext(t,r){var e,o,c,p,u,h,m,n;this.lastContext=t,this.contextHistory.unshift(t),this.contextHistory.length>this.MAX_HISTORY_SIZE&&this.contextHistory.pop();try{g.set("last_context",t),g.set("context_history",this.contextHistory)}catch(l){console.error("컨텍스트 저장 오류:",l)}try{const l=((o=(e=t.thread_context)==null?void 0:e.collection_stats)==null?void 0:o.found_tweets)||0,y=((u=(p=(c=t.thread_context)==null?void 0:c.mainTweet)==null?void 0:p.author)==null?void 0:u.username)||"N/A",a=((n=(m=(h=t.thread_context)==null?void 0:h.replyTarget)==null?void 0:m.author)==null?void 0:n.username)||"N/A";s.addLog("컨텍스트가 저장되었습니다","success",{tweet_count:l,main_tweet_author:y,reply_target_author:a,timestamp:t.timestamp})}catch(l){console.error("컨텍스트 로깅 오류:",l)}},getLastContext(){return this.lastContext},getContextHistory(){return this.contextHistory},async initialize(){try{const t=await g.get("last_context");t&&(this.lastContext=t);const r=await g.get("context_history");Array.isArray(r)&&(this.contextHistory=r)}catch(t){console.error("컨텍스트 초기화 오류:",t)}}};chrome.runtime.onInstalled.addListener(async t=>{const r=t.reason;console.log(`X 헬퍼가 ${r}되었습니다.`),await g.set("settings",L),await s.clearLogs(),await s.addLog(`X 헬퍼가 ${r}되었습니다.`,"info"),await T.initialize(),d.keepAlive()});chrome.runtime.onStartup.addListener(()=>{console.log("X 헬퍼가 시작되었습니다."),s.addLog("X 헬퍼가 시작되었습니다.","info"),d.keepAlive()});chrome.tabs.onRemoved.addListener(t=>{b.unregisterContentScript(t),delete I[t.toString()]});function i(t,r){try{t(r)}catch(e){console.error("응답 전송 오류:",e)}}chrome.runtime.onMessage.addListener((t,r,e)=>{var p,u,h,m;if(t&&t.responseId&&d.hasPendingResponse(t.responseId))return d.executePendingResponse(t.responseId,t.data),!1;const{action:o,data:c}=t;if((p=r.tab)!=null&&p.id&&b.registerContentScript(r.tab.id),o==="ping")return i(e,{pong:!0,timestamp:Date.now(),uptime:Math.floor((Date.now()-d.startTime)/1e3)}),!0;if(o==="getSettings")return g.get("settings").then(n=>{i(e,{settings:n||L})}).catch(n=>{console.error("설정 로드 오류:",n),i(e,{error:"설정 로드 중 오류가 발생했습니다."})}),!0;if(o==="saveSettings")return g.set("settings",c).then(()=>{s.addLog("설정이 업데이트되었습니다.","info",c),i(e,{success:!0})}).catch(n=>{console.error("설정 저장 오류:",n),i(e,{error:"설정 저장 중 오류가 발생했습니다."})}),!0;if(o==="addLog"){try{const{message:n,type:l,details:y}=c;s.addLog(n,l,y).then(()=>{i(e,{success:!0})}).catch(a=>{console.error("로그 추가 오류:",a),i(e,{error:"로그 추가 중 오류가 발생했습니다."})})}catch(n){console.error("로그 데이터 처리 오류:",n),i(e,{error:"로그 데이터 처리 중 오류가 발생했습니다."})}return!0}if(o==="getLogs")return s.getLogs().then(n=>{i(e,{logs:n})}).catch(n=>{console.error("로그 조회 오류:",n),i(e,{error:"로그 조회 중 오류가 발생했습니다."})}),!0;if(o==="clearLogs")return s.clearLogs().then(()=>{i(e,{success:!0})}).catch(n=>{console.error("로그 초기화 오류:",n),i(e,{error:"로그 초기화 중 오류가 발생했습니다."})}),!0;if(o==="getLastContext"){try{const n=T.getLastContext();i(e,{context:n})}catch(n){console.error("컨텍스트 조회 오류:",n),i(e,{error:"컨텍스트 조회 중 오류가 발생했습니다."})}return!0}if(o==="getContextHistory"){try{const n=T.getContextHistory();i(e,{history:n})}catch(n){console.error("컨텍스트 히스토리 조회 오류:",n),i(e,{error:"컨텍스트 히스토리 조회 중 오류가 발생했습니다."})}return!0}if(o==="generateResponse"){try{s.addLog("AI 응답 생성 요청 수신","info",c);const n=(u=r.tab)==null?void 0:u.id;if(!n)return s.addLog("탭 ID를 찾을 수 없습니다.","error"),i(e,{error:"탭 ID를 찾을 수 없습니다."}),!0;const l={user_input:c.tweetText,thread_context:c.threadContext,settings:{tone:c.tone,model:c.model},timestamp:new Date().toISOString()};if(T.saveContext(l,n),c.threadContext){const a=c.threadContext;s.addLog("트윗 스레드 구조 분석","info",{structure:a.threadStructure,tweetCount:(((h=a.intermediateReplies)==null?void 0:h.length)||0)+(a.mainTweet?1:0)+(a.replyTarget?1:0)}),a.mainTweet&&s.addLog("메인 트윗 감지됨","info",{author:a.mainTweet.author.username,text:a.mainTweet.text.substring(0,100)+(a.mainTweet.text.length>100?"...":"")}),a.replyTarget&&s.addLog("답장 대상 트윗 감지됨","info",{author:a.replyTarget.author.username,text:a.replyTarget.text.substring(0,100)+(a.replyTarget.text.length>100?"...":"")}),a.intermediateReplies&&a.intermediateReplies.length>0&&s.addLog(`${a.intermediateReplies.length}개의 중간 답글 감지됨`,"info")}n&&(I[n.toString()]=c),(async()=>{try{const a=await g.get("settings")||L,v=(a==null?void 0:a.apiKey)||"",A=(a==null?void 0:a.model)||"gpt-3.5-turbo",x=P(c.threadContext);s.addLog("Web3 Degen 프롬프트 생성 완료","info",{promptLength:x.userPrompt.length}),setTimeout(async()=>{try{let f=[];try{s.addLog("OpenAI API 호출 시작","info");const w=await O(x,v,A);f=$(w),s.addLog("OpenAI 응답 파싱 완료","success",{response_count:f.length})}catch(w){s.addLog("응답 생성 오류","error",w),f=[{text:"응답 생성 중 오류가 발생했습니다. 다시 시도하거나 API 키 설정을 확인해주세요.",type:"error"}]}b.isContentScriptActive(n).then(w=>{w?i(e,{responses:f}):(s.addLog("콘텐츠 스크립트 연결이 끊어졌습니다.","error"),i(e,{error:"콘텐츠 스크립트 연결이 끊어졌습니다."}))}).catch(()=>{i(e,{responses:f})})}catch(f){s.addLog("응답 생성 중 오류 발생","error",f),i(e,{error:"응답 생성 중 오류가 발생했습니다."})}},500)}catch(a){s.addLog("설정 및 프롬프트 생성 중 오류","error",a),i(e,{error:"응답 생성 중 오류가 발생했습니다."})}})()}catch(n){s.addLog("응답 생성 요청 처리 중 오류","error",n),i(e,{error:"응답 생성 요청 처리 중 오류가 발생했습니다."})}return!0}if(o==="copyContext"){const n=(m=t.tabId)==null?void 0:m.toString();if(n&&I[n]){const l=JSON.stringify(I[n],null,2);_(l).then(()=>{s.addLog("컨텍스트가 클립보드에 복사되었습니다.","success"),i(e,{success:!0,message:"컨텍스트가 클립보드에 복사되었습니다."})}).catch(y=>{s.addLog("클립보드 복사 실패","error",y),i(e,{error:"클립보드 복사 중 오류가 발생했습니다."})})}else s.addLog("사용 가능한 컨텍스트가 없습니다.","error"),i(e,{success:!1,message:"사용 가능한 컨텍스트가 없습니다."});return!0}return i(e,{error:`지원되지 않는 액션: ${o}`}),!0});async function _(t){try{const e=(await chrome.tabs.create({url:"about:blank",active:!1})).id;if(!e)throw new Error("탭 ID를 찾을 수 없습니다.");await chrome.scripting.executeScript({target:{tabId:e},func:o=>{navigator.clipboard.writeText(o).then(()=>console.log("클립보드에 복사 성공")).catch(c=>console.error("클립보드 복사 실패:",c))},args:[t]}),await new Promise(o=>setTimeout(o,500)),await chrome.tabs.remove(e)}catch(r){throw console.error("클립보드 복사 함수 오류:",r),r}}chrome.runtime.onSuspend.addListener(()=>{console.log("서비스 워커가 일시 중단됩니다."),s.addLog("서비스 워커가 일시 중단됩니다.","warn"),d.cleanup()});chrome.runtime.onSuspendCanceled.addListener(()=>{console.log("서비스 워커 중단이 취소되었습니다."),s.addLog("서비스 워커 중단이 취소되었습니다.","info"),d.keepAlive()});d.keepAlive();function $(t){const r=[],e=t.split(`

`);try{for(const o of e)o.trim()!==""&&(o.startsWith("1/")?r.push({text:o.substring(2).trim(),type:"greeting"}):o.startsWith("2/")?r.push({text:o.substring(2).trim(),type:"agreement"}):o.startsWith("3/")?r.push({text:o.substring(2).trim(),type:"joke"}):(console.warn("Unexpected response format:",o),r.push({text:o.trim(),type:"default"})));return r.length===0&&console.error("응답 파싱 오류: 올바른 형식의 응답이 없습니다",t),r}catch(o){return console.error("응답 파싱 중 오류 발생:",o),[{text:t,type:"error"}]}}async function O(t,r,e="gpt-3.5-turbo"){var o,c,p;try{if(!r)throw new Error("OpenAI API 키가 설정되지 않았습니다.");const u={model:e,messages:[{role:"system",content:t.systemPrompt},{role:"user",content:t.userPrompt}],temperature:.7,max_tokens:1e3};s.addLog("OpenAI API 요청","info",{model:e,prompt_length:t.userPrompt.length,temperature:.7,max_tokens:1e3});const h=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(u)});if(!h.ok){const l=await h.json();throw new Error(`OpenAI API 오류: ${((o=l.error)==null?void 0:o.message)||"알 수 없는 오류"}`)}const m=await h.json(),n=((p=(c=m.choices[0])==null?void 0:c.message)==null?void 0:p.content)||"";return s.addLog("OpenAI API 응답 수신","success",{response_length:n.length,usage:m.usage}),n}catch(u){return s.addLog("OpenAI API 오류","error",u.message),`1/ API 오류로 응답을 생성할 수 없습니다. 설정에서 API 키를 확인해주세요!

2/ "${u.message}"

3/ 개발자에게 이 오류 메시지를 전달해주세요.`}}
