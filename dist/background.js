class p{static async get(r){try{return(await chrome.storage.local.get(r))[r]}catch(e){console.error(`스토리지에서 데이터 가져오기 실패: ${e}`);return}}static async set(r,e){try{await chrome.storage.local.set({[r]:e})}catch(o){console.error(`스토리지에 데이터 저장 실패: ${o}`)}}static async remove(r){try{await chrome.storage.local.remove(r)}catch(e){console.error(`스토리지에서 데이터 삭제 실패: ${e}`)}}static onChanged(r){chrome.storage.onChanged.addListener((e,o)=>{o==="local"&&r(e)})}}const P={친근한:{systemPrompt:`당신은 X.com(트위터)에서 사용자를 돕는 AI 비서입니다.
친근하고 따뜻한 톤으로 대화하며, 복잡한 전문 용어보다는 일상 언어를 사용합니다.
사용자의 감정에 공감하고, 긍정적인 태도로 응답하세요.
가능한 한 짧고 명확하게 답변하며, 이모지를 적절히 사용해 친근함을 표현하세요.`,userPrompt:`다음은 X.com(트위터)에서의 대화 컨텍스트입니다:
{{THREAD_CONTEXT}}

사용자는 다음 트윗에 대한 답변을 작성하려고 합니다:
{{USER_INPUT}}

친근하고 따뜻한 톤으로 3개의 가능한 답변을 작성해주세요. 각 답변은 280자 이내로 작성하고, 가능한 한 이모지를 포함해주세요.`},전문적인:{systemPrompt:`당신은 X.com(트위터)에서 사용자를 돕는 전문 비서입니다.
전문적이고 정중한 톤으로 대화하며, 필요시 적절한 전문 용어를 사용해 정확성을 높입니다.
객관적인 정보를 바탕으로 논리적인 답변을 제공하세요.
간결하고 명확한 문장 구조를 사용하며, 형식적인 언어를 적절히 활용하세요.`,userPrompt:`다음은 X.com(트위터)에서의 대화 컨텍스트입니다:
{{THREAD_CONTEXT}}

사용자는 다음 트윗에 대한 답변을 작성하려고 합니다:
{{USER_INPUT}}

전문적이고 정중한 톤으로 3개의 가능한 답변을 작성해주세요. 각 답변은 280자 이내로 작성하고, 사실에 기반한 정확한 정보를 포함해주세요.`},유머러스한:{systemPrompt:`당신은 X.com(트위터)에서 사용자를 돕는 위트 있는 AI 비서입니다.
유머러스하고 가벼운 톤으로 대화하며, 재치 있는 표현과 적절한 농담을 사용합니다.
창의적이고 의외성 있는 답변으로 대화에 즐거움을 더하세요.
과하지 않은 범위에서 언어유희나 문화 레퍼런스를 활용할 수 있습니다.`,userPrompt:`다음은 X.com(트위터)에서의 대화 컨텍스트입니다:
{{THREAD_CONTEXT}}

사용자는 다음 트윗에 대한 답변을 작성하려고 합니다:
{{USER_INPUT}}

유머러스하고 위트 있는 톤으로 3개의 가능한 답변을 작성해주세요. 각 답변은 280자 이내로 작성하고, 재미있는 요소를 포함해주세요.`},학술적인:{systemPrompt:`당신은 X.com(트위터)에서 사용자를 돕는 학술적 AI 비서입니다.
학술적이고 분석적인 톤으로 대화하며, 복잡한 주제에 대해 심층적인 통찰을 제공합니다.
논리적 구조와 비판적 사고를 바탕으로 답변하며, 필요시 참고 자료나 근거를 제시하세요.
정확한 용어와 구체적인 예시를 사용해 개념을 명확히 설명하세요.`,userPrompt:`다음은 X.com(트위터)에서의 대화 컨텍스트입니다:
{{THREAD_CONTEXT}}

사용자는 다음 트윗에 대한 답변을 작성하려고 합니다:
{{USER_INPUT}}

학술적이고 분석적인 톤으로 3개의 가능한 답변을 작성해주세요. 각 답변은 280자 이내로 작성하고, 논리적 구조와, 가능하다면 관련 근거를 포함해주세요.`}};function _(t){if(!t)return"대화 컨텍스트 없음";let r="";if(t.mainTweet){const e=t.mainTweet;r+=`메인 트윗 (@${e.author.username}): "${e.text}"

`}if(t.intermediateReplies&&t.intermediateReplies.length>0&&(r+=`중간 답글들:
`,t.intermediateReplies.forEach((e,o)=>{r+=`${o+1}. @${e.author.username}: "${e.text}"
`}),r+=`
`),t.replyTarget){const e=t.replyTarget;r+=`답장 대상 (@${e.author.username}): "${e.text}"`}return r}function A(t,r,e,o=!1,s=""){const h=_(e);if(o&&s)return{systemPrompt:`당신은 X.com(트위터)에서 사용자를 돕는 AI 비서입니다.
사용자가 제공한 맞춤형 지시에 따라 답변을 생성하세요.`,userPrompt:s.replace(/{{THREAD_CONTEXT}}/g,h).replace(/{{USER_INPUT}}/g,r||"(작성 중인 텍스트 없음)")};const m=P[t]||P.친근한,d=m.userPrompt.replace("{{THREAD_CONTEXT}}",h).replace("{{USER_INPUT}}",r||"(작성 중인 텍스트 없음)");return{systemPrompt:m.systemPrompt,userPrompt:d}}const y={isAlive:!0,startTime:Date.now(),pingInterval:null,wakeInterval:null,pendingResponses:new Map,keepAlive(){this.wakeInterval&&(clearInterval(this.wakeInterval),this.wakeInterval=null),this.wakeInterval=setInterval(()=>{this.isAlive=!0;const t=Math.floor((Date.now()-this.startTime)/1e3);console.debug(`백그라운드 스크립트 활성 유지 중 (가동 시간: ${t}초)`),t>0&&t%1500===0&&c.addLog(`백그라운드 스크립트 가동 중 (${Math.floor(t/60)}분)`,"info")},15e3),this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.pingInterval=setInterval(async()=>{try{await this.pingContentScriptTabs()}catch(t){console.debug("탭 핑 오류:",t)}},3e4)},async pingContentScriptTabs(){const t=[...S.contentScriptTabs];for(const r of t)try{await S.isContentScriptActive(r)}catch(e){console.debug(`탭 ${r} 핑 실패:`,e)}},registerPendingResponse(t,r){this.pendingResponses.set(t,r),setTimeout(()=>{this.pendingResponses.delete(t)},1e4)},hasPendingResponse(t){return this.pendingResponses.has(t)},executePendingResponse(t,r){if(this.pendingResponses.has(t)){try{this.pendingResponses.get(t)(r)}catch(e){console.error("응답 콜백 실행 오류:",e)}return this.pendingResponses.delete(t),!0}return!1},cleanup(){this.wakeInterval&&(clearInterval(this.wakeInterval),this.wakeInterval=null),this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.pendingResponses.clear()}},S={active:!0,contentScriptTabs:new Set,registerContentScript(t){this.contentScriptTabs.add(t),console.log(`콘텐츠 스크립트 등록: 탭 ${t}`)},unregisterContentScript(t){this.contentScriptTabs.delete(t),console.log(`콘텐츠 스크립트 연결 해제: 탭 ${t}`)},async broadcastMessage(t){const r=[...this.contentScriptTabs];for(const e of r)try{await chrome.tabs.sendMessage(e,t)}catch(o){console.warn(`탭 ${e}에 메시지 전송 실패:`,o),this.unregisterContentScript(e)}},async isContentScriptActive(t){if(!this.contentScriptTabs.has(t))return!1;try{const r=await Promise.race([chrome.tabs.sendMessage(t,{action:"ping",timestamp:Date.now()}),new Promise((e,o)=>setTimeout(()=>o(new Error("Ping timeout")),2e3))]);return!0}catch(r){return console.warn(`탭 ${t} 연결 확인 실패:`,r),this.unregisterContentScript(t),!1}},async checkAllContentScripts(){const t=[...this.contentScriptTabs],r=[];for(const e of t)try{const o=await this.isContentScriptActive(e);r.push({tabId:e,active:o})}catch{r.push({tabId:e,active:!1})}return r}},$={isEnabled:!0,apiKey:"",model:"gpt-3.5-turbo",toneOptions:["친근한","전문적인","유머러스한","학술적인"],selectedTone:"친근한",useCustomPrompt:!1,customPrompt:""},c={MAX_LOGS:100,async addLog(t,r="info",e){const o=await this.getLogs(),s={timestamp:new Date().toISOString(),message:t,type:r,details:e?JSON.stringify(e):void 0};o.unshift(s),o.length>this.MAX_LOGS&&o.pop(),await p.set("debug_logs",o),console.log(`[${r.toUpperCase()}] ${t}`,e||""),this.notifyLogUpdate()},async getLogs(){const t=await p.get("debug_logs");return Array.isArray(t)?t:[]},async clearLogs(){await p.set("debug_logs",[]),this.notifyLogUpdate()},notifyLogUpdate(){try{chrome.runtime.sendMessage({action:"logUpdated"})}catch{console.debug("로그 업데이트 알림 실패 (팝업이 열려있지 않을 수 있음)")}}},L={},v={lastContext:null,contextHistory:[],MAX_HISTORY_SIZE:10,saveContext(t,r){var e,o,s,h,m,d,T,n;this.lastContext=t,this.contextHistory.unshift(t),this.contextHistory.length>this.MAX_HISTORY_SIZE&&this.contextHistory.pop();try{p.set("last_context",t),p.set("context_history",this.contextHistory)}catch(u){console.error("컨텍스트 저장 오류:",u)}try{const u=((o=(e=t.thread_context)==null?void 0:e.collection_stats)==null?void 0:o.found_tweets)||0,x=((m=(h=(s=t.thread_context)==null?void 0:s.mainTweet)==null?void 0:h.author)==null?void 0:m.username)||"N/A",a=((n=(T=(d=t.thread_context)==null?void 0:d.replyTarget)==null?void 0:T.author)==null?void 0:n.username)||"N/A";c.addLog("컨텍스트가 저장되었습니다","success",{tweet_count:u,main_tweet_author:x,reply_target_author:a,timestamp:t.timestamp})}catch(u){console.error("컨텍스트 로깅 오류:",u)}},getLastContext(){return this.lastContext},getContextHistory(){return this.contextHistory},async initialize(){try{const t=await p.get("last_context");t&&(this.lastContext=t);const r=await p.get("context_history");Array.isArray(r)&&(this.contextHistory=r)}catch(t){console.error("컨텍스트 초기화 오류:",t)}}};chrome.runtime.onInstalled.addListener(async t=>{const r=t.reason;console.log(`X 헬퍼가 ${r}되었습니다.`),await p.set("settings",$),await c.clearLogs(),await c.addLog(`X 헬퍼가 ${r}되었습니다.`,"info"),await v.initialize(),y.keepAlive()});chrome.runtime.onStartup.addListener(()=>{console.log("X 헬퍼가 시작되었습니다."),c.addLog("X 헬퍼가 시작되었습니다.","info"),y.keepAlive()});chrome.tabs.onRemoved.addListener(t=>{S.unregisterContentScript(t),delete L[t.toString()]});function i(t,r){try{t(r)}catch(e){console.error("응답 전송 오류:",e)}}chrome.runtime.onMessage.addListener((t,r,e)=>{var h,m,d,T;if(t&&t.responseId&&y.hasPendingResponse(t.responseId))return y.executePendingResponse(t.responseId,t.data),!1;const{action:o,data:s}=t;if((h=r.tab)!=null&&h.id&&S.registerContentScript(r.tab.id),o==="ping")return i(e,{pong:!0,timestamp:Date.now(),uptime:Math.floor((Date.now()-y.startTime)/1e3)}),!0;if(o==="getSettings")return p.get("settings").then(n=>{i(e,{settings:n||$})}).catch(n=>{console.error("설정 로드 오류:",n),i(e,{error:"설정 로드 중 오류가 발생했습니다."})}),!0;if(o==="saveSettings")return p.set("settings",s).then(()=>{c.addLog("설정이 업데이트되었습니다.","info",s),i(e,{success:!0})}).catch(n=>{console.error("설정 저장 오류:",n),i(e,{error:"설정 저장 중 오류가 발생했습니다."})}),!0;if(o==="addLog"){try{const{message:n,type:u,details:x}=s;c.addLog(n,u,x).then(()=>{i(e,{success:!0})}).catch(a=>{console.error("로그 추가 오류:",a),i(e,{error:"로그 추가 중 오류가 발생했습니다."})})}catch(n){console.error("로그 데이터 처리 오류:",n),i(e,{error:"로그 데이터 처리 중 오류가 발생했습니다."})}return!0}if(o==="getLogs")return c.getLogs().then(n=>{i(e,{logs:n})}).catch(n=>{console.error("로그 조회 오류:",n),i(e,{error:"로그 조회 중 오류가 발생했습니다."})}),!0;if(o==="clearLogs")return c.clearLogs().then(()=>{i(e,{success:!0})}).catch(n=>{console.error("로그 초기화 오류:",n),i(e,{error:"로그 초기화 중 오류가 발생했습니다."})}),!0;if(o==="getLastContext"){try{const n=v.getLastContext();i(e,{context:n})}catch(n){console.error("컨텍스트 조회 오류:",n),i(e,{error:"컨텍스트 조회 중 오류가 발생했습니다."})}return!0}if(o==="getContextHistory"){try{const n=v.getContextHistory();i(e,{history:n})}catch(n){console.error("컨텍스트 히스토리 조회 오류:",n),i(e,{error:"컨텍스트 히스토리 조회 중 오류가 발생했습니다."})}return!0}if(o==="generateResponse"){try{c.addLog("AI 응답 생성 요청 수신","info",s);const n=(m=r.tab)==null?void 0:m.id;if(!n)return c.addLog("탭 ID를 찾을 수 없습니다.","error"),i(e,{error:"탭 ID를 찾을 수 없습니다."}),!0;const u={user_input:s.tweetText,thread_context:s.threadContext,settings:{tone:s.tone,model:s.model},timestamp:new Date().toISOString()};if(v.saveContext(u,n),s.threadContext){const a=s.threadContext;c.addLog("트윗 스레드 구조 분석","info",{structure:a.threadStructure,tweetCount:(((d=a.intermediateReplies)==null?void 0:d.length)||0)+(a.mainTweet?1:0)+(a.replyTarget?1:0)}),a.mainTweet&&c.addLog("메인 트윗 감지됨","info",{author:a.mainTweet.author.username,text:a.mainTweet.text.substring(0,100)+(a.mainTweet.text.length>100?"...":"")}),a.replyTarget&&c.addLog("답장 대상 트윗 감지됨","info",{author:a.replyTarget.author.username,text:a.replyTarget.text.substring(0,100)+(a.replyTarget.text.length>100?"...":"")}),a.intermediateReplies&&a.intermediateReplies.length>0&&c.addLog(`${a.intermediateReplies.length}개의 중간 답글 감지됨`,"info")}n&&(L[n.toString()]=s),(async()=>{try{let a=s.tone||"친근한",I=!1,C="";try{const f=await p.get("settings");if(f){const w=f;a=s.tone||w.selectedTone||"친근한",I=w.useCustomPrompt||!1,C=w.customPrompt||""}}catch(f){c.addLog("설정 로드 중 오류 발생, 기본값 사용","warn",f)}const b=A(a,s.tweetText,s.threadContext,I,C);c.addLog("프롬프트 생성 완료","info",{tone:a,customPrompt:I,promptLength:b.userPrompt.length}),setTimeout(()=>{var f,w;try{let g=[];const X=((f=s.threadContext)==null?void 0:f.mainTweet)!=null;if(((w=s.threadContext)==null?void 0:w.replyTarget)!=null){const l=s.threadContext.replyTarget.author.username||"";a==="친근한"?g=[{text:`${l} 네, 말씀해주신 내용에 동의합니다! 좋은 의견 감사해요 😊`,type:"friendly"},{text:`${l} 흥미로운 관점이네요~ 더 자세히 알려주실 수 있을까요? 🤔`,type:"curious"},{text:`${l} 좋은 지적이에요! 저도 비슷한 생각을 했었는데 공감되네요 👍`,type:"agree"}]:a==="전문적인"?g=[{text:`${l} 귀하의 의견에 동의합니다. 해당 관점은 이 분야에서 중요한 시사점을 제공합니다.`,type:"professional"},{text:`${l} 흥미로운 관점입니다. 추가적인 데이터나 근거가 있으시면 논의를 더 발전시킬 수 있을 것 같습니다.`,type:"analytical"},{text:`${l} 정확한 지적입니다. 이 부분에 대해서는 최근 연구에서도 유사한 결론이 도출되었습니다.`,type:"informative"}]:a==="유머러스한"?g=[{text:`${l} 당신 말이 너무 맞아서 제 키보드가 박수를 치려다 망가졌어요! 😂 완전 동의합니다!`,type:"funny"},{text:`${l} 그 의견은 피자처럼 완벽해요 - 아무리 접어도 맛있죠! 🍕 더 자세히 말해주실래요?`,type:"witty"},{text:`${l} 저도 그 생각을 하고 있었는데! 위대한 마음이 같이 움직인다고 하죠... 아니면 그냥 둘 다 멋진가요? 😎`,type:"playful"}]:a==="학술적인"?g=[{text:`${l} 귀하의 주장은 상당히 설득력이 있습니다. 특히 이론적 관점에서 볼 때 기존 패러다임에 중요한 질문을 제기합니다.`,type:"scholarly"},{text:`${l} 흥미로운 가설입니다. 이 현상에 대한 체계적 분석을 위해서는 추가 데이터가 필요할 것으로 보입니다.`,type:"analytical"},{text:`${l} 해당 관점은 문헌에서 지지되는 바, Smith(2023)와 Johnson(2024)의 연구에서도 유사한 결론이 도출되었습니다.`,type:"referenced"}]:g=[{text:`${l} 좋은 의견 감사합니다!`,type:"default"},{text:`${l} 흥미로운 관점이네요. 더 설명해주실 수 있나요?`,type:"curious"},{text:`${l} 동의합니다. 추가 의견이 있으시면 말씀해주세요.`,type:"agree"}]}else a==="친근한"?g=[{text:"네, 말씀해주신 내용에 동의합니다! 좋은 의견 감사해요 😊",type:"friendly"},{text:"흥미로운 관점이네요~ 더 자세히 알려주실 수 있을까요? 🤔",type:"curious"},{text:"좋은 지적이에요! 저도 비슷한 생각을 했었는데 공감되네요 👍",type:"agree"}]:a==="전문적인"?g=[{text:"귀하의 의견에 동의합니다. 해당 관점은 이 분야에서 중요한 시사점을 제공합니다.",type:"professional"},{text:"흥미로운 관점입니다. 추가적인 데이터나 근거가 있으시면 논의를 더 발전시킬 수 있을 것 같습니다.",type:"analytical"},{text:"정확한 지적입니다. 이 부분에 대해서는 최근 연구에서도 유사한 결론이 도출되었습니다.",type:"informative"}]:a==="유머러스한"?g=[{text:"당신 말이 너무 맞아서 제 키보드가 박수를 치려다 망가졌어요! 😂 완전 동의합니다!",type:"funny"},{text:"그 의견은 피자처럼 완벽해요 - 아무리 접어도 맛있죠! 🍕 더 자세히 말해주실래요?",type:"witty"},{text:"저도 그 생각을 하고 있었는데! 위대한 마음이 같이 움직인다고 하죠... 아니면 그냥 둘 다 멋진가요? 😎",type:"playful"}]:a==="학술적인"?g=[{text:"귀하의 주장은 상당히 설득력이 있습니다. 특히 이론적 관점에서 볼 때 기존 패러다임에 중요한 질문을 제기합니다.",type:"scholarly"},{text:"흥미로운 가설입니다. 이 현상에 대한 체계적 분석을 위해서는 추가 데이터가 필요할 것으로 보입니다.",type:"analytical"},{text:"해당 관점은 문헌에서 지지되는 바, 최근 연구에서도 유사한 결론이 도출되었습니다.",type:"referenced"}]:g=[{text:"네, 말씀해주신 내용에 동의합니다. 좋은 의견 감사합니다!",type:"default"},{text:"흥미로운 관점이네요. 더 설명해주실 수 있나요?",type:"curious"},{text:"동의합니다. 추가 의견이 있으시면 말씀해주세요.",type:"agree"}];g.push({text:`// 프롬프트 정보: 톤=${a}, 길이=${b.userPrompt.length}자`,type:"debug"}),c.addLog("AI 응답 생성 완료","success",g),S.isContentScriptActive(n).then(l=>{l?i(e,{responses:g}):(c.addLog("콘텐츠 스크립트 연결이 끊어졌습니다.","error"),i(e,{error:"콘텐츠 스크립트 연결이 끊어졌습니다."}))}).catch(()=>{i(e,{responses:g})})}catch(g){c.addLog("응답 생성 중 오류 발생","error",g),i(e,{error:"응답 생성 중 오류가 발생했습니다."})}},500)}catch(a){c.addLog("설정 및 프롬프트 생성 중 오류","error",a),i(e,{error:"응답 생성 중 오류가 발생했습니다."})}})()}catch(n){c.addLog("응답 생성 요청 처리 중 오류","error",n),i(e,{error:"응답 생성 요청 처리 중 오류가 발생했습니다."})}return!0}if(o==="copyContext"){const n=(T=t.tabId)==null?void 0:T.toString();if(n&&L[n]){const u=JSON.stringify(L[n],null,2);E(u).then(()=>{c.addLog("컨텍스트가 클립보드에 복사되었습니다.","success"),i(e,{success:!0,message:"컨텍스트가 클립보드에 복사되었습니다."})}).catch(x=>{c.addLog("클립보드 복사 실패","error",x),i(e,{error:"클립보드 복사 중 오류가 발생했습니다."})})}else c.addLog("사용 가능한 컨텍스트가 없습니다.","error"),i(e,{success:!1,message:"사용 가능한 컨텍스트가 없습니다."});return!0}return i(e,{error:`지원되지 않는 액션: ${o}`}),!0});async function E(t){try{const e=(await chrome.tabs.create({url:"about:blank",active:!1})).id;if(!e)throw new Error("탭 ID를 찾을 수 없습니다.");await chrome.scripting.executeScript({target:{tabId:e},func:o=>{navigator.clipboard.writeText(o).then(()=>console.log("클립보드에 복사 성공")).catch(s=>console.error("클립보드 복사 실패:",s))},args:[t]}),await new Promise(o=>setTimeout(o,500)),await chrome.tabs.remove(e)}catch(r){throw console.error("클립보드 복사 함수 오류:",r),r}}chrome.runtime.onSuspend.addListener(()=>{console.log("서비스 워커가 일시 중단됩니다."),c.addLog("서비스 워커가 일시 중단됩니다.","warn"),y.cleanup()});chrome.runtime.onSuspendCanceled.addListener(()=>{console.log("서비스 워커 중단이 취소되었습니다."),c.addLog("서비스 워커 중단이 취소되었습니다.","info"),y.keepAlive()});y.keepAlive();
